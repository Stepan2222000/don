================================================================================
КОНЦЕПЦИЯ: ВРЕМЕННОЕ ОТКЛЮЧЕНИЕ ПРОКСИ
================================================================================
Дата: 2024-12-16
Статус: Планирование

================================================================================
1. ЦЕЛЬ
================================================================================

Сделать возможность временно отключать прокси для браузеров:
- Глобально для всех профилей
- Или для конкретных профилей по выбору

При этом:
- Привязки прокси к профилям СОХРАНЯЮТСЯ (в БД и в metadata.json)
- При включении обратно — всё работает как раньше
- Работает и в Donut Browser UI (кнопка Launch), и в автоматизации

================================================================================
2. ТЕКУЩАЯ АРХИТЕКТУРА
================================================================================

ИСТОЧНИКИ ПРОКСИ:
-----------------
1. Donut Browser профили:
   - donutbrowser/data/profiles/{uuid}/metadata.json
   - Поле: proxy_id → ссылка на файл прокси

2. Файлы прокси:
   - donutbrowser/data/proxies/{uuid}.json
   - Содержит: host, port, username, password

3. База данных PostgreSQL:
   - Таблица: proxy_assignments
   - Связь: proxy_url ↔ profile_id


ДВЕ СИСТЕМЫ ЗАПУСКА БРАУЗЕРА:
-----------------------------

A) Donut Browser UI (кнопка Launch):
   UI → Rust (browser_runner.rs) → nodecar sidecar → Playwright

   Прокси: Запускается локальный прокси-сервер,
           который проксирует через upstream (настоящий прокси)

B) tg-automatizamtion (Python скрипты):
   Python → browser_automation.py → Playwright напрямую

   Прокси: Передаются напрямую в Playwright


ПОТОК ПРОКСИ В АВТОМАТИЗАЦИИ:
-----------------------------
1. worker.py вызывает proxy_manager.get_or_assign_proxy()
2. Проверяется БД → если нет, берётся из profile.proxy
3. Передаётся в browser_automation.launch_browser(proxy_override=...)
4. Внутри: proxy_url = proxy_override или profile.proxy
5. Playwright запускается с proxy_config

================================================================================
3. КАК ДОЛЖНО РАБОТАТЬ ПОСЛЕ ИЗМЕНЕНИЙ
================================================================================

НАСТРОЙКИ В config.yaml:
------------------------
proxy:
  enabled: true                    # Глобальный переключатель (true/false)
  disabled_profiles: []            # Список UUID профилей без прокси
  pool_file: "data/proxies.txt"    # Остальные настройки без изменений
  ...


ЛОГИКА РАБОТЫ:
--------------

1. ГЛОБАЛЬНОЕ ОТКЛЮЧЕНИЕ (enabled: false):
   - ВСЕ профили запускаются БЕЗ прокси
   - Браузеры идут через обычное интернет-соединение
   - Привязки в БД и файлах НЕ трогаются

2. ОТКЛЮЧЕНИЕ ДЛЯ КОНКРЕТНЫХ ПРОФИЛЕЙ (disabled_profiles: ["uuid1", "uuid2"]):
   - Только указанные профили запускаются без прокси
   - Остальные — с прокси как обычно

3. ПРИ ВКЛЮЧЕНИИ ОБРАТНО (enabled: true, disabled_profiles: []):
   - Всё работает как раньше
   - Привязки сохранились, ничего не потеряно


ВЛИЯНИЕ НА DONUT BROWSER UI:
----------------------------
Python-код читает config.yaml.
Donut Browser (Rust) тоже должен читать config.yaml для проверки настроек.

При нажатии Launch в UI:
- Rust читает config.yaml
- Если proxy.enabled = false или профиль в disabled_profiles:
  - НЕ запускать локальный прокси-сервер
  - Браузер запускается напрямую без прокси

================================================================================
4. ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЙ
================================================================================

TG-AUTOMATIZAMTION (Python):
----------------------------
1. src/config.py
   - Добавить в ProxyConfig:
     enabled: bool = True
     disabled_profiles: List[str] = []

2. config.yaml
   - Добавить параметры:
     proxy:
       enabled: true
       disabled_profiles: []

3. src/browser_automation.py
   - Добавить параметр disable_proxy в launch_browser()
   - Если disable_proxy=True → proxy_config = None (игнорировать profile.proxy)

4. src/worker.py
   - Проверять config.proxy.enabled
   - Проверять профиль в config.proxy.disabled_profiles
   - Передавать disable_proxy=True в launch_browser() когда нужно


DONUT BROWSER (Rust):
---------------------
1. src-tauri/src/browser_runner.rs (строки 136-179)
   - Перед запуском прокси проверять config.yaml
   - Если отключено — пропускать запуск локального прокси

2. (опционально) Добавить функцию чтения config.yaml из tg-automatizamtion


ФАЙЛЫ БЕЗ ИЗМЕНЕНИЙ (данные сохраняются):
-----------------------------------------
- donutbrowser/data/profiles/*/metadata.json (proxy_id остаётся)
- donutbrowser/data/proxies/*.json (файлы прокси остаются)
- PostgreSQL proxy_assignments (привязки остаются)

================================================================================
5. ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ
================================================================================

ПРИМЕР 1: Отключить прокси для всех профилей
--------------------------------------------
Редактируем config.yaml:

proxy:
  enabled: false        # <-- Меняем на false
  disabled_profiles: []
  pool_file: "data/proxies.txt"

Результат: Все браузеры запускаются без прокси


ПРИМЕР 2: Отключить прокси для конкретных профилей
--------------------------------------------------
Редактируем config.yaml:

proxy:
  enabled: true
  disabled_profiles:    # <-- Добавляем UUID профилей
    - "7ff6a624-fc9d-4d9f-a622-61be23e42298"
    - "dbcbf072-7bca-4452-97a2-859cba13a44e"
  pool_file: "data/proxies.txt"

Результат: Профили "1" и "3" без прокси, остальные с прокси


ПРИМЕР 3: Включить прокси обратно
---------------------------------
Редактируем config.yaml:

proxy:
  enabled: true         # <-- Меняем на true
  disabled_profiles: [] # <-- Очищаем список
  pool_file: "data/proxies.txt"

Результат: Все профили работают с прокси как раньше

================================================================================
6. ЛОГИРОВАНИЕ
================================================================================

При работе без прокси в логах будет:

[INFO] Proxy disabled in config - running without proxy
[INFO] Launching browser for profile: 1
[INFO] Browser launched successfully (no proxy)

================================================================================
7. ВАЖНЫЕ ЗАМЕЧАНИЯ
================================================================================

1. ПРИВЯЗКИ СОХРАНЯЮТСЯ
   При отключении прокси данные НЕ удаляются:
   - proxy_assignments в БД остаётся
   - proxy_id в metadata.json остаётся
   - Файлы proxies/*.json остаются

2. БЫСТРОЕ ПЕРЕКЛЮЧЕНИЕ
   Достаточно изменить enabled: false/true в config.yaml
   Не нужно перезапускать ничего кроме браузера

3. DONUT BROWSER UI
   После изменения config.yaml нужно перезапустить браузер
   (закрыть и нажать Launch заново)

4. АВТОМАТИЗАЦИЯ
   Изменения применяются при следующем запуске worker'а

================================================================================
